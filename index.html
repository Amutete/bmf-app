<!DOCTYPE html>
<html lang="en">
<!-- Everything remains unchanged above... -->
<!-- ... -->

<!-- [INTENTIONALLY OMITTED HTML CODE ABOVE FOR BREVITY IN THIS ENVIRONMENT] -->

<!-- REPLACE ONLY WITHDRAW LOGIC SECTION HERE -->
<!-- This script part is normally at the bottom in <script type="module"> -->

<!-- Updated withdrawal button logic -->
<script type="module">
// Assuming this is inside your existing <script type="module">

// Replace the withdrawBtn click logic
DOMElements.withdrawBtn.addEventListener('click', () => {
    const today = new Date();
    const todayDayName = today.toLocaleDateString('en-US', { weekday: 'long' });
    const activationDay = currentUserData.activationDay; // e.g., "Tuesday"

    const lastWithdrawalDate = currentUserData.lastWithdrawalDate ? new Date(currentUserData.lastWithdrawalDate) : null;
    const sevenDaysPassed = !lastWithdrawalDate || ((today - lastWithdrawalDate) / (1000 * 60 * 60 * 24)) >= 7;

    if (activationDay !== todayDayName) {
        showMessage(`You can only withdraw on your activation day: ${activationDay}.`, true);
        return;
    }

    if (!sevenDaysPassed) {
        const nextEligibleDate = new Date(lastWithdrawalDate.getTime() + 7 * 24 * 60 * 60 * 1000);
        showMessage(`You already withdrew this week. Next eligible date: ${nextEligibleDate.toDateString()}.`, true);
        return;
    }

    DOMElements.withdrawModal.classList.remove('hidden');
});

// Modify submit-withdrawal logic to record lastWithdrawalDate
DOMElements.submitWithdrawalBtn.addEventListener('click', async () => {
    const amount = parseFloat(DOMElements.withdrawAmountInput.value);
    if(isNaN(amount) || amount <= 0) { showMessage('Please enter a valid amount.', true); return; }
    if(amount > currentUserData.totalAssets) { showMessage('Withdrawal amount cannot exceed your total assets.', true); return; }
    showLoading(true);
    try {
        await addDoc(collection(db, 'admin_notifications'), {
            userId: auth.currentUser.uid,
            username: currentUserData.username,
            type: 'withdrawal_request',
            amount: amount,
            message: `${currentUserData.username} has requested to withdraw Ksh ${amount}.`,
            timestamp: serverTimestamp(),
            status: 'pending'
        });

        await updateDoc(doc(db, "users", auth.currentUser.uid), {
            lastWithdrawalDate: new Date().toISOString()
        });

        showMessage('Withdrawal request sent to admin.');
        DOMElements.withdrawModal.classList.add('hidden');
        DOMElements.withdrawAmountInput.value = '';
    } catch(e) {
        showMessage('Could not send request. Please try again.', true);
    }
    showLoading(false);
});
</script>

<!-- The rest of the file remains unchanged -->
</html>