<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMF - Investment App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .bmf-logo-text { font-weight: 900; letter-spacing: -0.05em; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        .nav-item.active { color: #f97316; }
        .btn-disabled { background-color: #d1d5db; cursor: not-allowed; }
        .notification-dot { display: none; }
        .notification-dot.active { display: block; }
        .timer-warning { color: #ef4444; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        /* Smooth transition for task switching */
        .task-container { transition: opacity 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Authentication Container -->
    <div id="auth-container" class="min-h-screen bg-gradient-to-br from-orange-400 to-orange-600 flex flex-col items-center justify-center p-4">
        <h1 class="text-7xl font-black text-white bmf-logo-text mb-6">BMF</h1>
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-6">
            <div class="flex border-b border-gray-200">
                <button id="login-tab-btn" class="flex-1 py-3 font-semibold text-lg border-b-4 border-orange-500 text-orange-500">Login</button>
                <button id="signup-tab-btn" class="flex-1 py-3 font-semibold text-lg text-gray-500">Sign Up</button>
            </div>
            <div id="error-message" class="mt-4 text-center text-red-500 font-medium h-auto"></div>
            <div class="mt-6">
                <form id="login-form">
                    <div class="mb-4"><label for="login-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500"></div>
                    <div class="mb-6"><label for="login-password" class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500"></div>
                    <button type="submit" class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600 transition duration-300 shadow-lg">Login</button>
                </form>
                <form id="signup-form" class="hidden">
                    <div class="mb-4"><label for="signup-username" class="block text-sm font-medium text-gray-700">Username</label><input type="text" id="signup-username" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500"></div>
                    <div class="mb-4"><label for="signup-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="signup-email" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500"></div>
                    <div class="mb-4"><label for="signup-password" class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="signup-password" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500"><p class="text-xs text-gray-500 mt-1">Minimum 6 characters.</p></div>
                    <div class="mb-6"><label for="signup-confirm-password" class="block text-sm font-medium text-gray-700">Confirm Password</label><input type="password" id="signup-confirm-password" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500"></div>
                    <button type="submit" class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600 transition duration-300 shadow-lg">Create Account</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden w-full max-w-lg mx-auto bg-white flex-col h-screen">
        <header class="bg-orange-500 text-white p-4 shadow-md flex justify-between items-center z-10 sticky top-0">
            <div><p class="text-sm">Welcome back,</p><h2 id="user-name-display" class="font-bold text-xl">User</h2></div>
            <div class="flex items-center">
                <div class="text-right mr-4"><p class="text-sm">Total Assets</p><h2 id="total-assets-display" class="font-bold text-xl">Ksh 0.00</h2></div>
                <button id="notification-btn" class="relative"><i class="fas fa-bell text-2xl"></i><div id="notification-dot" class="notification-dot absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></div></button>
            </div>
        </header>

        <main class="flex-grow p-4 overflow-y-auto pb-24">
            <!-- Home Page -->
            <div id="page-home">
                <h3 class="font-bold text-2xl text-gray-800 mb-4">Dashboard</h3>
                <div class="grid grid-cols-2 gap-3 text-center mb-6">
                    <div id="deposit-btn" class="bg-gray-100 p-4 rounded-xl shadow-sm cursor-pointer hover:bg-gray-200 transition"><i class="fa-solid fa-wallet text-orange-500 text-2xl"></i><p class="font-semibold text-sm mt-1">Deposit</p></div>
                    <div id="withdraw-btn" class="bg-gray-100 p-4 rounded-xl shadow-sm cursor-pointer hover:bg-gray-200 transition"><i class="fa-solid fa-money-bill-transfer text-orange-500 text-2xl"></i><p class="font-semibold text-sm mt-1">Withdraw</p></div>
                </div>
                <div class="space-y-6">
                    <div>
                        <h4 class="font-bold text-xl text-gray-700 mb-2">Freelance Levels</h4>
                        <div class="bg-white rounded-lg shadow overflow-hidden"><table class="min-w-full text-sm"><thead class="bg-gray-50"><tr><th class="py-2 px-2 text-left font-semibold text-gray-600">Investment (Ksh)</th><th class="py-2 px-2 text-center font-semibold text-gray-600">Tasks</th><th class="py-2 px-2 text-right font-semibold text-gray-600">Max Daily (Ksh)</th></tr></thead><tbody class="divide-y divide-gray-200"><tr><td class="py-3 px-2">4,000</td><td class="py-3 px-2 text-center">8</td><td class="py-3 px-2 text-right">130</td></tr><tr><td class="py-3 px-2">10,000</td><td class="py-3 px-2 text-center">8</td><td class="py-3 px-2 text-right">300</td></tr><tr><td class="py-3 px-2">25,000</td><td class="py-3 px-2 text-center">6</td><td class="py-3 px-2 text-right">800</td></tr><tr><td class="py-3 px-2">50,000</td><td class="py-3 px-2 text-center">6</td><td class="py-3 px-2 text-right">1,600</td></tr></tbody></table></div>
                    </div>
                </div>
            </div>
            <!-- Work Page -->
            <div id="page-work" class="hidden">
                 <h3 class="font-bold text-2xl text-gray-800 mb-6">Today's Tasks</h3>
                 <div id="work-content"></div>
            </div>
            <!-- Profit Page -->
            <div id="page-profit" class="hidden">
                 <h3 class="font-bold text-2xl text-gray-800 mb-6">Profit Overview</h3>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-gray-100 p-4 rounded-xl text-center"><p class="font-semibold text-gray-600">Total Task Profits</p><p id="profit-tasks" class="font-bold text-2xl text-gray-800">Ksh 0.00</p></div>
                    <div class="bg-gray-100 p-4 rounded-xl text-center"><p class="font-semibold text-gray-600">Total Referral Bonuses</p><p id="profit-referrals" class="font-bold text-2xl text-gray-800">Ksh 0.00</p></div>
                </div>
                <h4 class="font-bold text-xl text-gray-700 mb-2">Transaction History</h4>
                <div id="transaction-log" class="space-y-4"></div>
            </div>
            <!-- My Profile Page -->
            <div id="page-my" class="hidden">
                <h3 class="font-bold text-2xl text-gray-800 mb-6">My Profile</h3>
                <div class="bg-white p-4 rounded-lg shadow mb-6"><h4 class="font-bold text-lg text-gray-700 mb-3">Personal Details</h4><div class="space-y-2 text-sm"><p><span class="font-semibold">Username:</span> <span id="my-username"></span></p><p><span class="font-semibold">Email:</span> <span id="my-email"></span></p><p><span class="font-semibold">User ID:</span> <span id="my-userid" class="text-xs text-gray-500"></span></p></div></div>
                <div class="bg-white p-4 rounded-lg shadow mb-6"><h4 class="font-bold text-lg text-gray-700 mb-3">My Referral Link</h4><div class="bg-gray-100 p-2 rounded-md flex items-center justify-between"><input id="referral-link-input" type="text" readonly value="Loading..." class="bg-transparent text-gray-600 text-xs w-full focus:outline-none"><button id="copy-referral-btn" class="bg-orange-500 text-white px-3 py-1 rounded text-sm font-semibold">Copy</button></div></div>
                <button id="logout-btn" class="w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 transition duration-300 shadow-lg">Logout</button>
            </div>
            <!-- Notifications Page -->
             <div id="page-notifications" class="hidden">
                <h3 class="font-bold text-2xl text-gray-800 mb-6">Notifications</h3>
                <div id="notifications-list" class="space-y-3"></div>
            </div>
        </main>

        <!-- Footer Navigation -->
        <footer class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around max-w-lg mx-auto">
             <button data-page="home" class="nav-item flex-1 py-3 text-center text-gray-600 hover:bg-gray-100 transition active"><i class="fas fa-home text-xl"></i><span class="block text-xs font-medium">Home</span></button>
             <button data-page="work" class="nav-item flex-1 py-3 text-center text-gray-600 hover:bg-gray-100 transition"><i class="fas fa-briefcase text-xl"></i><span class="block text-xs font-medium">Work</span></button>
             <button data-page="profit" class="nav-item flex-1 py-3 text-center text-gray-600 hover:bg-gray-100 transition"><i class="fas fa-chart-line text-xl"></i><span class="block text-xs font-medium">Profit</span></button>
             <button data-page="my" class="nav-item flex-1 py-3 text-center text-gray-600 hover:bg-gray-100 transition"><i class="fas fa-user text-xl"></i><span class="block text-xs font-medium">My</span></button>
        </footer>
    </div>
    
    <!-- Modals -->
    <div id="message-modal" class="hidden fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-xl z-50 animate-pulse"><p id="message-modal-text"></p></div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, increment, collection, addDoc, getDoc, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAwf6foE2lZcv90wnQIRXguq-Z7jkIX8r8",
            authDomain: "bmf-6447b.firebaseapp.com",
            projectId: "bmf-6447b",
            storageBucket: "bmf-6447b.appspot.com",
            messagingSenderId: "249416500752",
            appId: "1:249416500752:web:88d421c17752fd08e7ac95",
            measurementId: "G-2SS309VMLB"
        };

        const INVESTMENT_LEVELS = {
            'level-4000': { investment: 4000, tasks: 8, maxDaily: 130 },
            'level-10000': { investment: 10000, tasks: 8, maxDaily: 300 },
            'level-25000': { investment: 25000, tasks: 6, maxDaily: 800 },
            'level-50000': { investment: 50000, tasks: 6, maxDaily: 1600 },
            'None': { investment: 0, tasks: 0, maxDaily: 0 }
        };

        const TASK_TIME_LIMIT = 30 * 60; // 30 minutes in seconds
        const WARNING_TIME = 5 * 60; // 5 minutes in seconds

        // --- GLOBAL STATE ---
        let app, auth, db;
        let currentUserData = null;
        let unsubscribe = {};
        let allTasks = [];
        let categorizedTasks = {};
        let currentTaskIndex = -1;
        let taskTimerInterval = null;
        let audioCtx;
        
        // --- DOM ELEMENTS ---
        const DOMElements = {
            authContainer: document.getElementById('auth-container'),
            appContainer: document.getElementById('app-container'),
            workContent: document.getElementById('work-content'),
        };

        // --- INITIALIZATION ---
        function initApp() {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            loadTasks();
            setupEventListeners();
            handleAuthentication();
        }

        async function loadTasks() {
            try {
                const response = await fetch('./work_tasks_dataset.json');
                if (!response.ok) throw new Error('Network response was not ok.');
                allTasks = await response.json();
                categorizeTasks();
            } catch (error) {
                console.error("Failed to load tasks:", error);
                DOMElements.workContent.innerHTML = `<p class="text-red-500">Error loading tasks. Please try again later.</p>`;
            }
        }

        function categorizeTasks() {
            categorizedTasks = allTasks.reduce((acc, task) => {
                if (!acc[task.type]) {
                    acc[task.type] = [];
                }
                acc[task.type].push(task);
                return acc;
            }, {});
        }

        // --- AUTHENTICATION ---
        function handleAuthentication() {
            onAuthStateChanged(auth, user => {
                if (user) {
                    DOMElements.authContainer.classList.add('hidden');
                    DOMElements.appContainer.style.display = 'flex';
                    listenToUserData(user);
                    switchPage('home');
                } else {
                    DOMElements.authContainer.classList.remove('hidden');
                    DOMElements.appContainer.style.display = 'none';
                    if (unsubscribe.userData) unsubscribe.userData();
                    currentUserData = null;
                }
            });
        }
        
        // --- DATA HANDLING ---
        function listenToUserData(user) {
            const userDocRef = doc(db, "users", user.uid);
            unsubscribe.userData = onSnapshot(userDocRef, async (doc) => {
                if (doc.exists()) {
                    currentUserData = { id: doc.id, ...doc.data() };
                    updateUIWithUserData(currentUserData);
                    await checkAndAssignDailyTasks();
                }
            });
        }

        // --- UI UPDATES ---
        function updateUIWithUserData(userData) {
            document.getElementById('user-name-display').textContent = userData.username;
            document.getElementById('total-assets-display').textContent = `Ksh ${userData.totalAssets.toFixed(2)}`;
        }

        // --- TASK LOGIC ---
        function getTodaysDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function checkAndAssignDailyTasks() {
            if (!currentUserData || !currentUserData.investmentLevel || currentUserData.investmentLevel === 'None' || Object.keys(categorizedTasks).length === 0) {
                return;
            }

            const todaysDate = getTodaysDateString();
            const lastTaskDate = currentUserData.dailyTasks ? currentUserData.dailyTasks.date : null;

            if (lastTaskDate !== todaysDate) {
                const levelKey = `level-${currentUserData.investmentLevel}`;
                const level = INVESTMENT_LEVELS[levelKey];
                if (!level) return;

                const userDocRef = doc(db, "users", auth.currentUser.uid);
                const newTasks = [];
                const assignedTaskIds = new Set();
                const categories = Object.keys(categorizedTasks);
                
                // Shuffle categories to get different task types at the start
                for (let i = categories.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [categories[i], categories[j]] = [categories[j], categories[i]];
                }

                for (let i = 0; i < level.tasks; i++) {
                    let task;
                    let attempts = 0;
                    do {
                        const category = categories[i % categories.length];
                        const categoryTasks = categorizedTasks[category];
                        const randomIndex = Math.floor(Math.random() * categoryTasks.length);
                        task = categoryTasks[randomIndex];
                        attempts++;
                    } while (assignedTaskIds.has(task.id) && attempts < 50);

                    if (task && !assignedTaskIds.has(task.id)) {
                        assignedTaskIds.add(task.id);
                        newTasks.push({
                            taskId: task.id,
                            status: 'pending',
                            attemptsLeft: 2,
                        });
                    }
                }

                const dailyTaskData = {
                    date: todaysDate,
                    tasks: newTasks,
                    isCompleted: false // Mark the day as not completed
                };
                await updateDoc(userDocRef, { dailyTasks: dailyTaskData });
            }
        }

        function renderWorkPage() {
            if (!currentUserData || !currentUserData.investmentLevel || currentUserData.investmentLevel === 'None') {
                DOMElements.workContent.innerHTML = `<p class="text-center text-gray-500 p-4 bg-gray-100 rounded-lg">You need to have an active investment to receive tasks.</p>`;
                return;
            }

            const dailyTasks = currentUserData.dailyTasks;
            const todaysDate = getTodaysDateString();

            if (!dailyTasks || dailyTasks.date !== todaysDate) {
                DOMElements.workContent.innerHTML = `<div class="text-center p-4"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500 mx-auto"></div><p class="mt-2 text-gray-600">Assigning today's tasks...</p></div>`;
                return;
            }
            
            if (dailyTasks.isCompleted) {
                 DOMElements.workContent.innerHTML = `<div class="text-center p-6 bg-green-100 text-green-800 rounded-lg shadow"><i class="fas fa-check-circle text-4xl mb-3"></i><h4 class="font-bold text-xl">All tasks for today completed!</h4><p>Come back tomorrow for new tasks.</p></div>`;
                 return;
            }

            currentTaskIndex = dailyTasks.tasks.findIndex(task => task.status === 'pending');
            renderCurrentTask();
        }
        
        function renderCurrentTask() {
            if (currentTaskIndex === -1) {
                // All tasks have been attempted, show completion screen
                renderCompletionScreen();
                return;
            }
            
            const task = currentUserData.dailyTasks.tasks[currentTaskIndex];
            const taskData = allTasks.find(t => t.id === task.taskId);

            if (!taskData) {
                DOMElements.workContent.innerHTML = `<p class="text-red-500">Error: Task data not found.</p>`;
                return;
            }
            
            DOMElements.workContent.innerHTML = `
                <div class="task-container bg-white rounded-2xl shadow-xl p-6 w-full">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-xl text-gray-800">Task ${currentTaskIndex + 1} of ${currentUserData.dailyTasks.tasks.length} <span class="text-sm font-normal text-gray-500">(${taskData.type})</span></h3>
                        <div class="text-right">
                            <p id="task-timer" class="font-bold text-lg text-gray-700">30:00</p>
                            <p id="task-attempts" class="text-sm text-gray-500">${task.attemptsLeft} attempts left</p>
                        </div>
                    </div>
                    <div class="mb-4 min-h-[60px]">
                        <p id="task-question" class="text-gray-700 text-lg">${taskData.question}</p>
                    </div>
                    <div id="task-answer-area" class="space-y-3"></div>
                    <div class="mt-6">
                        <button id="submit-task-btn" class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600 transition shadow-lg">Submit Answer</button>
                    </div>
                </div>
            `;
            
            const answerArea = document.getElementById('task-answer-area');
            switch(taskData.type) {
                case 'math': case 'captcha': case 'proofreading':
                    answerArea.innerHTML = `<input type="text" id="task-answer-input" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500">`;
                    break;
                case 'review':
                     answerArea.innerHTML = `<textarea id="task-answer-input" rows="4" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500" placeholder="Write at least ${taskData.minWords} words."></textarea>`;
                    break;
                case 'trivia':
                    const optionsHtml = taskData.options.map((option, index) => `
                        <label class="flex items-center space-x-3 p-3 rounded-md hover:bg-gray-100 cursor-pointer border border-gray-200">
                            <input type="radio" name="trivia-option" value="${index}" class="form-radio h-5 w-5 text-orange-600">
                            <span class="text-gray-700">${option}</span>
                        </label>
                    `).join('');
                    answerArea.innerHTML = `<div id="task-answer-input" class="space-y-2">${optionsHtml}</div>`;
                    break;
            }
            
            document.getElementById('submit-task-btn').addEventListener('click', submitTaskAnswer);
            startTaskTimer();
        }

        function renderCompletionScreen() {
             const tasks = currentUserData.dailyTasks.tasks;
             const allPassed = tasks.every(t => t.status === 'completed');
             const levelKey = `level-${currentUserData.investmentLevel}`;
             const level = INVESTMENT_LEVELS[levelKey];
             
             let summaryHtml = tasks.map((task, index) => {
                const icon = task.status === 'completed' ? '<i class="fas fa-check-circle text-green-500"></i>' : '<i class="fas fa-times-circle text-red-500"></i>';
                return `<li class="flex justify-between items-center py-2"><span>Task ${index + 1}</span><span class="font-bold">${icon} ${task.status}</span></li>`;
             }).join('');
             
             let resultMessage = allPassed 
                ? `<div class="text-center p-4 bg-green-100 text-green-800 rounded-lg"><h4 class="font-bold text-xl">Congratulations!</h4><p>All tasks passed. You will be awarded Ksh ${level.maxDaily.toFixed(2)}.</p></div>`
                : `<div class="text-center p-4 bg-red-100 text-red-800 rounded-lg"><h4 class="font-bold text-xl">Tasks Failed</h4><p>You did not complete all tasks successfully. You will receive no reward for today.</p></div>`;

             DOMElements.workContent.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl p-6 w-full">
                    <h3 class="font-bold text-xl text-gray-800 mb-4">Daily Summary</h3>
                    ${resultMessage}
                    <ul class="divide-y divide-gray-200 my-4">${summaryHtml}</ul>
                    <button id="finalize-day-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition shadow-lg">Complete Day's Work</button>
                </div>
             `;
             document.getElementById('finalize-day-btn').addEventListener('click', finalizeDailyTasks);
        }

        function startTaskTimer() {
            let timeLeft = TASK_TIME_LIMIT;
            const timerEl = document.getElementById('task-timer');
            
            if (taskTimerInterval) clearInterval(taskTimerInterval);

            taskTimerInterval = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                if (timerEl) {
                    timerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }

                if (timeLeft <= WARNING_TIME && timerEl) {
                    timerEl.classList.add('timer-warning');
                    if(timeLeft % 3 === 0) playWarningSound();
                }

                if (timeLeft <= 0) {
                    clearInterval(taskTimerInterval);
                    handleTaskFailure("Time's up!");
                }
            }, 1000);
        }

        async function submitTaskAnswer() {
            if (currentTaskIndex === -1) return;
            document.getElementById('submit-task-btn').disabled = true;

            const task = currentUserData.dailyTasks.tasks[currentTaskIndex];
            const taskData = allTasks.find(t => t.id === task.taskId);
            let userAnswer;
            let isCorrect = false;

            switch(taskData.type) {
                case 'math':
                    userAnswer = document.getElementById('task-answer-input').value;
                    isCorrect = Number(userAnswer) === taskData.answer;
                    break;
                case 'captcha': case 'proofreading':
                    userAnswer = document.getElementById('task-answer-input').value.trim();
                    isCorrect = userAnswer.toLowerCase() === taskData.answer.toLowerCase();
                    break;
                case 'review':
                    userAnswer = document.getElementById('task-answer-input').value.trim();
                    const wordCount = userAnswer.split(/\s+/).filter(word => word.length > 0).length;
                    isCorrect = wordCount >= taskData.minWords;
                    break;
                case 'trivia':
                    const selectedOption = document.querySelector('input[name="trivia-option"]:checked');
                    if (selectedOption) {
                        userAnswer = selectedOption.value;
                        isCorrect = Number(userAnswer) === taskData.correctIndex;
                    }
                    break;
            }

            if (isCorrect) {
                await handleTaskSuccess();
            } else {
                await handleTaskFailure('Incorrect answer.');
            }
        }

        async function handleTaskSuccess() {
            clearInterval(taskTimerInterval);
            let updatedTasks = [...currentUserData.dailyTasks.tasks];
            updatedTasks[currentTaskIndex].status = 'completed';
            
            await updateDoc(doc(db, "users", auth.currentUser.uid), { 'dailyTasks.tasks': updatedTasks });
            
            showMessage('Correct!', 'success');
            moveToNextTask();
        }

        async function handleTaskFailure(reason) {
            let updatedTasks = [...currentUserData.dailyTasks.tasks];
            let currentTask = updatedTasks[currentTaskIndex];
            currentTask.attemptsLeft--;

            if (currentTask.attemptsLeft <= 0) {
                clearInterval(taskTimerInterval);
                currentTask.status = 'failed';
                await updateDoc(doc(db, "users", auth.currentUser.uid), { 'dailyTasks.tasks': updatedTasks });
                showMessage(`Task failed. ${reason}`, 'error');
                moveToNextTask();
            } else {
                await updateDoc(doc(db, "users", auth.currentUser.uid), { 'dailyTasks.tasks': updatedTasks });
                document.getElementById('task-attempts').textContent = `${currentTask.attemptsLeft} attempts left`;
                showMessage(`${reason} You have ${currentTask.attemptsLeft} attempt(s) left.`, 'error');
                document.getElementById('submit-task-btn').disabled = false;
            }
        }
        
        function moveToNextTask() {
            const container = document.querySelector('.task-container');
            if (container) {
                container.style.opacity = 0;
            }
            setTimeout(() => {
                currentTaskIndex = currentUserData.dailyTasks.tasks.findIndex(task => task.status === 'pending');
                renderCurrentTask();
            }, 300); // Wait for fade out
        }
        
        async function finalizeDailyTasks() {
            const tasks = currentUserData.dailyTasks.tasks;
            const allPassed = tasks.every(t => t.status === 'completed');
            const levelKey = `level-${currentUserData.investmentLevel}`;
            const level = INVESTMENT_LEVELS[levelKey];
            const userDocRef = doc(db, "users", auth.currentUser.uid);

            const batch = writeBatch(db);
            
            if(allPassed && level) {
                const reward = level.maxDaily;
                batch.update(userDocRef, {
                    totalAssets: increment(reward),
                    taskProfits: increment(reward)
                });
                const transactionsColRef = collection(db, "users", auth.currentUser.uid, "transactions");
                batch.set(doc(transactionsColRef), {
                    amount: reward,
                    type: 'Daily Task Reward',
                    timestamp: serverTimestamp(),
                    details: `Completed all tasks for ${getTodaysDateString()}`
                });
            }
            
            batch.update(userDocRef, { 'dailyTasks.isCompleted': true });
            await batch.commit();

            if (allPassed) {
                showMessage('Daily reward has been added to your assets!', 'success');
            } else {
                showMessage('Tasks for today are now closed.', 'error');
            }
            renderWorkPage(); // Re-render to show completion message
        }

        function playWarningSound() {
            if (!audioCtx) {
                try {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.error("Web Audio API is not supported in this browser");
                    return;
                }
            }
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.1);
        }

        // --- PAGE NAVIGATION ---
        function switchPage(pageId) {
            document.querySelectorAll('main > div').forEach(page => page.classList.add('hidden'));
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`.nav-item[data-page="${pageId}"]`).classList.add('active');
            
            if (pageId === 'work' && auth.currentUser) {
                renderWorkPage();
            }
        }
        
        // --- UTILITY FUNCTIONS ---
        function showMessage(message, type = 'success') {
            const modal = document.getElementById('message-modal');
            const text = document.getElementById('message-modal-text');
            modal.className = 'hidden';
            void modal.offsetWidth;
            text.textContent = message;
            modal.classList.remove('hidden');
            modal.classList.add('fixed', 'top-5', 'right-5', 'text-white', 'py-2', 'px-4', 'rounded-lg', 'shadow-xl', 'z-50', 'animate-pulse');
            modal.classList.toggle('bg-red-500', type === 'error');
            modal.classList.toggle('bg-green-500', type !== 'error');
            setTimeout(() => { modal.classList.add('hidden'); }, 3000);
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            document.querySelectorAll('.nav-item').forEach(button => {
                button.addEventListener('click', () => switchPage(button.dataset.page));
            });
            const loginForm = document.getElementById('login-form');
            loginForm.addEventListener('submit', e => {
                e.preventDefault();
                signInWithEmailAndPassword(auth, loginForm['login-email'].value, loginForm['login-password'].value).catch(err => showMessage(err.message, 'error'));
            });
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        }

        // --- APP ENTRY POINT ---
        initApp();
    </script>
</body>
</html>
