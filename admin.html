<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMF - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-200">

    <div id="admin-login-container" class="min-h-screen flex items-center justify-center">
        <div class="w-full max-w-sm bg-white rounded-2xl shadow-xl p-8">
            <h1 class="text-3xl font-bold text-center text-orange-500 mb-6">BMF Admin Login</h1>
            <div id="admin-error-message" class="mb-4 text-center text-red-500 font-medium h-5"></div>
            <form id="admin-login-form">
                <div class="mb-4">
                    <label for="admin-email" class="block text-sm font-medium text-gray-700">Admin Email</label>
                    <input type="email" id="admin-email" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                </div>
                <div class="mb-6">
                    <label for="admin-password" class="block text-sm font-medium text-gray-700">Admin Password</label>
                    <input type="password" id="admin-password" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                </div>
                <button type="submit" class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600 transition duration-300 shadow-lg">Login</button>
            </form>
        </div>
    </div>

    <div id="admin-panel-container" class="hidden container mx-auto p-4 md:p-8">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">BMF Admin Panel</h1>
            <button id="admin-logout-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600">Logout</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div>
                <h2 class="text-2xl font-bold text-gray-700 mb-4">Notifications</h2>
                <div id="notifications-list" class="space-y-4 bg-white p-4 rounded-lg shadow max-h-96 overflow-y-auto">
                    <p class="text-gray-500">No new notifications.</p>
                </div>
            </div>
            <div>
                <h2 class="text-2xl font-bold text-gray-700 mb-4">All Users</h2>
                <div id="users-list" class="space-y-4 bg-white p-4 rounded-lg shadow max-h-96 overflow-y-auto">
                     <p class="text-gray-500">Loading users...</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="user-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 id="modal-username" class="font-bold text-xl mb-4">User Details</h3>
            <div class="space-y-3">
                <div>
                    <label for="modal-level" class="block text-sm font-medium text-gray-700">Investment Level</label>
                    <select id="modal-level" class="mt-1 block w-full p-2 bg-gray-50 border border-gray-300 rounded-md">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                 <div>
                    <label for="modal-bonus" class="block text-sm font-medium text-gray-700">Add 5% Investment Bonus?</label>
                    <select id="modal-bonus" class="mt-1 block w-full p-2 bg-gray-50 border border-gray-300 rounded-md">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                <button id="update-user-btn" class="w-full bg-orange-500 text-white font-bold py-2 rounded-lg hover:bg-orange-600">Update User</button>
            </div>
            <button id="close-user-modal-btn" class="mt-4 w-full text-center text-gray-600 font-semibold">Close</button>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, updateDoc, onSnapshot, query, orderBy, getDocs, deleteDoc, increment, getDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAwf6foE2lZcv90wnQIRXguq-Z7jkIX8r8",
            authDomain: "bmf-6447b.firebaseapp.com",
            projectId: "bmf-6447b",
            storageBucket: "bmf-6447b.appspot.com",
            messagingSenderId: "249416500752",
            appId: "1:249416500752:web:88d421c17752fd08e7ac95",
            measurementId: "G-2SS309VMLB"
        };
        
        const ADMIN_EMAIL = "cleophasamutete@gmail.com"; 

        const INVESTMENT_LEVELS = {
            'freelance-1': { name: 'Freelance 1', investment: 4000 }, 'freelance-2': { name: 'Freelance 2', investment: 10000 }, 'freelance-3': { name: 'Freelance 3', investment: 25000 }, 'freelance-4': { name: 'Freelance 4', investment: 50000 },
            'manager-1': { name: 'Teamleader', investment: 100000 }, 'manager-2': { name: 'Supervisor', investment: 200000 }, 'manager-3': { name: 'Manager', investment: 500000 },
        };

        const app = initializeApp(firebaseConfig, "adminApp");
        const auth = getAuth(app);
        const db = getFirestore(app);

        const adminLoginContainer = document.getElementById('admin-login-container');
        const adminPanelContainer = document.getElementById('admin-panel-container');
        const adminLoginForm = document.getElementById('admin-login-form');
        const adminErrorMessage = document.getElementById('admin-error-message');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        const notificationsList = document.getElementById('notifications-list');
        const usersList = document.getElementById('users-list');
        const userModal = document.getElementById('user-modal');
        const modalUsername = document.getElementById('modal-username');
        const modalLevelSelect = document.getElementById('modal-level');
        const modalBonusSelect = document.getElementById('modal-bonus');
        const updateUserBtn = document.getElementById('update-user-btn');
        const closeModalBtn = document.getElementById('close-user-modal-btn');
        let selectedUserId = null;

        onAuthStateChanged(auth, user => {
            if (user && user.email.toLowerCase() === ADMIN_EMAIL) {
                adminLoginContainer.classList.add('hidden');
                adminPanelContainer.classList.remove('hidden');
                loadNotifications();
                loadUsers();
            } else {
                adminLoginContainer.classList.remove('hidden');
                adminPanelContainer.classList.add('hidden');
                if (user) { signOut(auth); } // Log out non-admin users automatically
            }
        });

        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = adminLoginForm['admin-email'].value;
            const password = adminLoginForm['admin-password'].value;
            adminErrorMessage.textContent = '';

            if (email.toLowerCase() !== ADMIN_EMAIL) {
                adminErrorMessage.textContent = "This email is not authorized for admin access.";
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                adminErrorMessage.textContent = error.message;
            }
        });

        adminLogoutBtn.addEventListener('click', () => signOut(auth));

        const loadNotifications = () => {
            const q = query(collection(db, 'admin_notifications'), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snapshot) => {
                notificationsList.innerHTML = '';
                if (snapshot.empty) {
                    notificationsList.innerHTML = '<p class="text-gray-500">No new notifications.</p>';
                    return;
                }
                snapshot.forEach(docSnap => {
                    const notif = docSnap.data();
                    const notifEl = document.createElement('div');
                    notifEl.className = 'border p-3 rounded-lg shadow-sm';
                    if (notif.type === 'deposit_paid') {
                        notifEl.innerHTML = `<p class="font-semibold">${notif.username} reported a deposit.</p><p class="text-xs text-gray-500">${notif.timestamp.toDate().toLocaleString()}</p><button data-docid="${docSnap.id}" class="ack-deposit-btn mt-2 bg-blue-500 text-white text-sm font-semibold py-1 px-2 rounded hover:bg-blue-600">Acknowledge</button>`;
                    } else if (notif.type === 'withdrawal_request') {
                         notifEl.innerHTML = `<p class="font-semibold">${notif.username} requests Ksh ${notif.amount}.</p><p class="text-xs text-gray-500">${notif.timestamp.toDate().toLocaleString()}</p><button data-uid="${notif.userId}" data-amount="${notif.amount}" data-docid="${docSnap.id}" class="approve-withdrawal-btn mt-2 bg-green-500 text-white text-sm font-semibold py-1 px-2 rounded hover:bg-green-600">Approve</button>`;
                    }
                    notificationsList.appendChild(notifEl);
                });
            });
        };
        
        const loadUsers = () => {
            const q = query(collection(db, 'users'), orderBy('createdAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                usersList.innerHTML = '';
                 snapshot.forEach(docSnap => {
                    const user = docSnap.data();
                    const userEl = document.createElement('div');
                    userEl.className = 'border p-3 rounded-lg flex justify-between items-center shadow-sm';
                    userEl.innerHTML = `<div><p class="font-bold">${user.username}</p><p class="text-sm text-gray-600">${user.email}</p><p class="text-xs text-gray-500">Assets: Ksh ${user.totalAssets.toFixed(2)} | Level: ${user.investmentLevel}</p></div><button data-uid="${user.uid}" data-uname="${user.username}" data-level="${user.investmentLevel}" class="manage-user-btn bg-gray-600 text-white text-sm font-semibold py-1 px-3 rounded hover:bg-gray-700">Manage</button>`;
                    usersList.appendChild(userEl);
                 });
            });
        };
        
        document.addEventListener('click', async (e) => {
            if(e.target.classList.contains('manage-user-btn')){
                selectedUserId = e.target.dataset.uid;
                modalUsername.textContent = `Manage: ${e.target.dataset.uname}`;
                populateLevelSelect(e.target.dataset.level);
                userModal.classList.remove('hidden');
            }
            if(e.target.classList.contains('ack-deposit-btn')){
                alert("Acknowledged. Remember to go to 'All Users' and set this user's investment level manually to activate their account.");
                await deleteDoc(doc(db, 'admin_notifications', e.target.dataset.docid));
            }
            if(e.target.classList.contains('approve-withdrawal-btn')){
                if(!confirm("CONFIRM: Have you already sent the money to the user? This action will deduct funds from their app balance and cannot be undone.")) return;
                const userId = e.target.dataset.uid;
                const amount = parseFloat(e.target.dataset.amount);
                try {
                    await updateDoc(doc(db, 'users', userId), { totalAssets: increment(-amount) });
                    await deleteDoc(doc(db, 'admin_notifications', e.target.dataset.docid));
                    alert("Success! Withdrawal approved and user's assets have been deducted.");
                } catch (err) {
                    alert("An error occurred: " + err.message);
                }
            }
        });
        
        closeModalBtn.addEventListener('click', () => userModal.classList.add('hidden'));

        updateUserBtn.addEventListener('click', async () => {
            if (!selectedUserId) return;
            const newLevel = modalLevelSelect.value;
            const giveBonus = modalBonusSelect.value === 'yes';

            const userRef = doc(db, 'users', selectedUserId);
            
            try {
                let contractEndDate = new Date();
                contractEndDate.setDate(contractEndDate.getDate() + 180);
                
                await updateDoc(userRef, {
                    investmentLevel: newLevel,
                    contractEndDate: contractEndDate
                });
                
                if (giveBonus) {
                    const userDoc = await getDoc(userRef);
                    const userData = userDoc.data();
                    if(userData.referrerId) {
                        const levelInfo = INVESTMENT_LEVELS[newLevel];
                        if(levelInfo) {
                            const bonusAmount = levelInfo.investment * 0.05;
                            const referrerRef = doc(db, "users", userData.referrerId);
                            await updateDoc(referrerRef, { totalAssets: increment(bonusAmount) });
                            await addDoc(collection(db, "transactions"), {
                                userId: userData.referrerId,
                                amount: bonusAmount,
                                type: 'referral-5%',
                                fromUser: userData.username,
                                timestamp: serverTimestamp()
                            });
                             alert(`User updated successfully. 5% bonus of Ksh ${bonusAmount} awarded to referrer.`);
                        }
                    } else {
                         alert("User updated successfully. No referrer found to award bonus to.");
                    }
                } else {
                     alert('User updated successfully!');
                }

                userModal.classList.add('hidden');
                selectedUserId = null;
            } catch (err) {
                 alert("An error occurred: " + err.message);
            }
        });

        const populateLevelSelect = (currentLevel) => {
            const levels = ['None', 'freelance-1', 'freelance-2', 'freelance-3', 'freelance-4', 'manager-1', 'manager-2', 'manager-3'];
            modalLevelSelect.innerHTML = levels.map(level => `<option value="${level}" ${level === currentLevel ? 'selected' : ''}>${level}</option>`).join('');
            modalBonusSelect.value = 'no'; // Default to no bonus
        };

    </script>
</body>
</html>
