<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMF - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Use a custom orange color for active items to match BMF branding */
        .admin-nav-item.active { background-color: #f97316; color: white; }
    </style>
</head>
<body class="bg-slate-100">

    <!-- Admin Login Screen -->
    <div id="admin-auth-container" class="min-h-screen bg-gray-800 flex items-center justify-center p-4">
        <div class="w-full max-w-sm bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold text-center text-slate-800 mb-6">BMF Admin Login</h2>
            <div id="admin-error-message" class="mb-4 text-center text-red-500 font-medium h-5"></div>
            <form id="admin-login-form">
                <div class="mb-4">
                    <label for="admin-login-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="admin-login-email" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                </div>
                <div class="mb-6">
                    <label for="admin-login-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="admin-login-password" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                </div>
                <button type="submit" class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600 transition duration-300 shadow-lg">Login</button>
            </form>
        </div>
    </div>

    <!-- Main Admin App -->
    <div id="admin-app-container" class="hidden">
        <header class="bg-slate-800 text-white p-4 flex justify-between items-center shadow-md">
            <h1 class="text-xl font-bold">BMF ADMIN</h1>
            <button id="admin-logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">Logout</button>
        </header>

        <div class="flex">
            <!-- Sidebar Navigation -->
            <nav class="w-48 bg-slate-700 min-h-screen p-4">
                <ul>
                    <li><button data-page="dashboard" class="admin-nav-item w-full text-left font-semibold py-2 px-3 rounded-lg mb-2 text-slate-200 hover:bg-slate-600 active">Dashboard</button></li>
                    <li><button data-page="users" class="admin-nav-item w-full text-left font-semibold py-2 px-3 rounded-lg mb-2 text-slate-200 hover:bg-slate-600">Users</button></li>
                    <li><button data-page="deposits" class="admin-nav-item w-full text-left font-semibold py-2 px-3 rounded-lg mb-2 text-slate-200 hover:bg-slate-600">Deposit Requests</button></li>
                    <li><button data-page="withdrawals" class="admin-nav-item w-full text-left font-semibold py-2 px-3 rounded-lg mb-2 text-slate-200 hover:bg-slate-600">Withdrawal Requests</button></li>
                </ul>
            </nav>
            
            <!-- Main Content Area -->
            <main class="flex-grow p-6">
                <!-- Dashboard Page -->
                <div id="admin-page-dashboard">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">Dashboard</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white p-4 rounded-lg shadow"><p class="text-slate-600">Total Users</p><p id="total-users-stat" class="text-3xl font-bold text-gray-800">0</p></div>
                        <div class="bg-white p-4 rounded-lg shadow"><p class="text-slate-600">Total Platform Assets</p><p id="total-assets-stat" class="text-3xl font-bold text-gray-800">Ksh 0.00</p></div>
                        <div class="bg-white p-4 rounded-lg shadow"><p class="text-slate-600">Pending Deposits</p><p id="pending-deposits-stat" class="text-3xl font-bold text-orange-500">0</p></div>
                        <div class="bg-white p-4 rounded-lg shadow"><p class="text-slate-600">Pending Withdrawals</p><p id="pending-withdrawals-stat" class="text-3xl font-bold text-orange-500">0</p></div>
                    </div>
                </div>

                <!-- Users Page -->
                <div id="admin-page-users" class="hidden">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">All Users</h2>
                    <div id="all-users-list" class="bg-white p-4 rounded-lg shadow max-h-[75vh] overflow-y-auto"></div>
                </div>

                <!-- Deposits Page -->
                <div id="admin-page-deposits" class="hidden">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">Deposit Requests</h2>
                    <div id="deposit-requests-list" class="bg-white p-4 rounded-lg shadow"></div>
                </div>

                <!-- Withdrawals Page -->
                <div id="admin-page-withdrawals" class="hidden">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">Withdrawal Requests</h2>
                    <div id="withdrawal-requests-list" class="bg-white p-4 rounded-lg shadow"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="manage-user-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md text-gray-800">
            <h3 class="font-bold text-xl mb-4" id="manage-user-title">Manage: User</h3>
            <div class="space-y-4">
                <div>
                    <label for="manage-level-select" class="block text-sm font-medium text-gray-700">Set/Update Investment Level</label>
                    <select id="manage-level-select" class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500"></select>
                </div>
                <div>
                    <label for="manage-bonus-select" class="block text-sm font-medium text-gray-700">Add 5% Referral Bonus to Sponsor?</label>
                    <select id="manage-bonus-select" class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                     <p class="text-xs text-slate-500 mt-1">Updating the level will activate the user and start a 180-day contract.</p>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="close-manage-modal-btn" class="bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">Close</button>
                <button id="update-user-btn" class="bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600">Update User & Activate</button>
            </div>
        </div>
    </div>
    <div id="message-modal" class="hidden fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-xl z-50 animate-pulse"><p id="message-modal-text"></p></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, getDoc, query, orderBy, increment, serverTimestamp, writeBatch, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener("DOMContentLoaded", () => {
            // --- BMF App Config ---
            const firebaseConfig = { apiKey: "AIzaSyAwf6foE2lZcv90wnQIRXguq-Z7jkIX8r8", authDomain: "bmf-6447b.firebaseapp.com", projectId: "bmf-6447b", storageBucket: "bmf-6447b.appspot.com", messagingSenderId: "249416500752", appId: "1:249416500752:web:88d421c17752fd08e7ac95", measurementId: "G-2SS309VMLB" };
            const ADMIN_EMAIL = 'cleophasamutete@gmail.com';
            const INVESTMENT_LEVELS = { 'freelance-1': { name: 'Freelance 1', investment: 4000 }, 'freelance-2': { name: 'Freelance 2', investment: 10000 }, 'freelance-3': { name: 'Freelance 3', investment: 25000 }, 'freelance-4': { name: 'Freelance 4', investment: 50000 }, 'manager-1': { name: 'Teamleader', investment: 100000 }, 'manager-2': { name: 'Supervisor', investment: 200000 }, 'manager-3': { name: 'Manager', investment: 500000 },'None': { name: 'None', investment: 0 }};
            const INACTIVITY_TIMEOUT = 15 * 60 * 1000; // 15 minutes
            
            let app, auth, db;
            let inactivityTimer;

            // --- Initialization ---
            try { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); } 
            catch (e) { console.error("Firebase init failed:", e); return; }

            // --- DOM Elements ---
            const DOMElements = {
                authContainer: document.getElementById('admin-auth-container'),
                appContainer: document.getElementById('admin-app-container'),
                errorMessage: document.getElementById('admin-error-message'),
                loginForm: document.getElementById('admin-login-form'),
                logoutBtn: document.getElementById('admin-logout-btn'),
                navItems: document.querySelectorAll('.admin-nav-item'),
                pages: { 
                    dashboard: document.getElementById('admin-page-dashboard'), 
                    users: document.getElementById('admin-page-users'), 
                    deposits: document.getElementById('admin-page-deposits'), 
                    withdrawals: document.getElementById('admin-page-withdrawals'), 
                },
                allUsersList: document.getElementById('all-users-list'),
                depositRequestsList: document.getElementById('deposit-requests-list'),
                withdrawalRequestsList: document.getElementById('withdrawal-requests-list'),
                totalUsersStat: document.getElementById('total-users-stat'),
                totalAssetsStat: document.getElementById('total-assets-stat'),
                pendingDepositsStat: document.getElementById('pending-deposits-stat'),
                pendingWithdrawalsStat: document.getElementById('pending-withdrawals-stat'),
                messageModal: document.getElementById('message-modal'),
                messageModalText: document.getElementById('message-modal-text'),
                manageUserModal: document.getElementById('manage-user-modal'),
                manageUserTitle: document.getElementById('manage-user-title'),
                manageLevelSelect: document.getElementById('manage-level-select'),
                manageBonusSelect: document.getElementById('manage-bonus-select'),
                closeManageModalBtn: document.getElementById('close-manage-modal-btn'),
                updateUserBtn: document.getElementById('update-user-btn'),
            };
            
            let selectedNotifDocId = null;

            // --- Helper & Core Functions ---
            const showMessage = (text, isError = false) => { DOMElements.messageModalText.textContent = text; DOMElements.messageModal.classList.toggle('bg-red-500', isError); DOMElements.messageModal.classList.toggle('bg-green-500', !isError); DOMElements.messageModal.classList.remove('hidden'); setTimeout(() => DOMElements.messageModal.classList.add('hidden'), 3500); };
            const switchPage = (pageName) => { Object.values(DOMElements.pages).forEach(p => p.classList.add('hidden')); if (DOMElements.pages[pageName]) DOMElements.pages[pageName].classList.remove('hidden'); DOMElements.navItems.forEach(item => item.classList.toggle('active', item.dataset.page === pageName)); };
            const formatCurrency = (amount) => `Ksh ${amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            const resetInactivityTimer = () => {
                clearTimeout(inactivityTimer);
                inactivityTimer = setTimeout(() => {
                    showMessage("Logged out due to inactivity.", true);
                    signOut(auth);
                }, INACTIVITY_TIMEOUT);
            };

            const setupInactivityDetection = () => {
                window.addEventListener('mousemove', resetInactivityTimer);
                window.addEventListener('keypress', resetInactivityTimer);
                resetInactivityTimer();
            };

            // --- Render Functions ---
            const renderAllUsers = (users) => {
                let totalAssets = 0;
                users.forEach(u => totalAssets += u.totalAssets || 0);
                DOMElements.totalUsersStat.textContent = users.length;
                DOMElements.totalAssetsStat.textContent = formatCurrency(totalAssets);

                DOMElements.allUsersList.innerHTML = `
                    <table class="min-w-full text-sm text-left">
                        <thead class="bg-slate-100"><tr>
                            <th class="p-2">Username</th><th>Email</th><th>Level</th><th>Balance</th><th>Contract Ends</th><th>Actions</th>
                        </tr></thead>
                        <tbody>${users.map(u => {
                            let daysRemaining = 'N/A';
                            if (u.contractEndDate && u.contractEndDate.toDate) {
                                const diffDays = Math.ceil((u.contractEndDate.toDate() - new Date()) / (1000 * 60 * 60 * 24));
                                daysRemaining = diffDays > 0 ? `${diffDays} days` : 'Expired';
                            }
                            return `<tr class="border-b">
                                <td class="p-2 font-semibold">${u.username}</td><td>${u.email}</td>
                                <td>${INVESTMENT_LEVELS[u.investmentLevel]?.name || 'N/A'}</td><td>${formatCurrency(u.totalAssets)}</td>
                                <td>${daysRemaining}</td>
                                <td><button data-user='${JSON.stringify(u)}' class="manage-user-btn bg-blue-500 text-white px-2 py-1 text-xs rounded hover:bg-blue-600">Manage</button></td>
                            </tr>`}).join('')}
                        </tbody>
                    </table>`;
            };

            const renderRequests = (requests, listElement, type) => {
                 listElement.innerHTML = requests.length === 0 ? '<p class="text-slate-500">No pending requests.</p>' : `
                    <div class="space-y-3">${requests.map(r => `
                        <div class="bg-slate-50 p-3 rounded-lg flex justify-between items-center">
                            <div>
                                <p class="font-semibold">${r.username}</p>
                                <p class="text-sm text-slate-600">${type === 'withdrawal' ? `requests a withdrawal of <span class="font-bold">${formatCurrency(r.amount)}</span>` : 'has notified of a deposit.'}</p>
                                <p class="text-xs text-slate-400">${r.timestamp.toDate().toLocaleString()}</p>
                            </div>
                            <div>
                                ${type === 'deposit' 
                                    ? `<button data-user='${JSON.stringify(r)}' data-docid="${r.id}" class="activate-user-btn bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">Activate User</button>` 
                                    : `<button data-id="${r.id}" data-uid="${r.userId}" data-amount="${r.amount}" class="approve-withdrawal-btn bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">Approve</button>`
                                }
                            </div>
                        </div>`).join('')}
                    </div>`;
            };

            const openManageUserModal = (user) => {
                DOMElements.manageUserTitle.textContent = `Manage: ${user.username}`;
                DOMElements.updateUserBtn.dataset.uid = user.uid;
                
                DOMElements.manageLevelSelect.innerHTML = Object.keys(INVESTMENT_LEVELS).map(key => `<option value="${key}" ${key === user.investmentLevel ? 'selected' : ''}>${INVESTMENT_LEVELS[key].name}</option>`).join('');
                DOMElements.manageBonusSelect.value = 'no';
                DOMElements.manageUserModal.classList.remove('hidden');
            };

            // --- Event Handlers ---
            DOMElements.loginForm.addEventListener('submit', async (e) => { 
                e.preventDefault(); 
                DOMElements.errorMessage.textContent = ''; 
                const email = DOMElements.loginForm['admin-login-email'].value; 
                if (email.toLowerCase() !== ADMIN_EMAIL) { 
                    DOMElements.errorMessage.textContent = 'Access denied. Incorrect email.'; 
                    return; 
                } 
                try { 
                    await signInWithEmailAndPassword(auth, email, DOMElements.loginForm['admin-login-password'].value); 
                } catch (error) { 
                    DOMElements.errorMessage.textContent = error.message.replace('Firebase: ', ''); 
                } 
            });

            DOMElements.logoutBtn.addEventListener('click', () => signOut(auth));
            DOMElements.navItems.forEach(item => item.addEventListener('click', () => switchPage(item.dataset.page)));
            
            DOMElements.allUsersList.addEventListener('click', (e) => {
                if(e.target.classList.contains('manage-user-btn')) openManageUserModal(JSON.parse(e.target.dataset.user));
            });

            DOMElements.depositRequestsList.addEventListener('click', (e) => {
                 if (e.target.classList.contains('activate-user-btn')) {
                    const user = JSON.parse(e.target.dataset.user);
                    selectedNotifDocId = e.target.dataset.docid;
                    openManageUserModal({uid: user.userId, username: user.username, investmentLevel: 'None'});
                    showMessage("Set the user's level to activate their account.", false);
                 }
            });

            DOMElements.withdrawalRequestsList.addEventListener('click', async (e) => {
                 if(e.target.classList.contains('approve-withdrawal-btn')){
                    if(!confirm("CONFIRM: Have you already sent the money to the user? This action will deduct funds from their app balance and cannot be undone.")) return;
                    try {
                        const batch = writeBatch(db);
                        const userRef = doc(db, 'users', e.target.dataset.uid);
                        const notifRef = doc(db, 'admin_notifications', e.target.dataset.id);
                        batch.update(userRef, { totalAssets: increment(-parseFloat(e.target.dataset.amount)) });
                        batch.delete(notifRef);
                        await batch.commit();
                        showMessage("Success! Withdrawal approved and user assets deducted.");
                    } catch (err) { showMessage("Error: " + err.message, true); }
                }
            });
            
            DOMElements.closeManageModalBtn.addEventListener('click', () => {
                DOMElements.manageUserModal.classList.add('hidden');
                selectedNotifDocId = null;
            });

            DOMElements.updateUserBtn.addEventListener('click', async (e) => {
                const uid = e.target.dataset.uid;
                if (!uid) return;
                
                const newLevel = DOMElements.manageLevelSelect.value;
                const giveBonus = DOMElements.manageBonusSelect.value === 'yes';
                const userRef = doc(db, 'users', uid);
                
                try {
                    const batch = writeBatch(db);
                    let contractEndDate = new Date(); 
                    contractEndDate.setDate(contractEndDate.getDate() + 180);
                    batch.update(userRef, { 
                        investmentLevel: newLevel, 
                        contractEndDate: newLevel !== 'None' ? contractEndDate : null 
                    });

                    // If this update came from a deposit notification, delete the notification
                    if(selectedNotifDocId) { 
                        const notifRef = doc(db, 'admin_notifications', selectedNotifDocId);
                        batch.delete(notifRef); 
                    }
                    
                    if (giveBonus) {
                        const userDoc = await getDoc(userRef);
                        const userData = userDoc.data();
                        if(userData.referrerId) {
                            const levelInfo = INVESTMENT_LEVELS[newLevel];
                            if(levelInfo && levelInfo.investment > 0) {
                                const bonusAmount = levelInfo.investment * 0.05;
                                const referrerRef = doc(db, "users", userData.referrerId);
                                batch.update(referrerRef, { totalAssets: increment(bonusAmount) });
                                
                                const transactionColRef = collection(db, "transactions");
                                batch.set(doc(transactionColRef), { userId: userData.referrerId, amount: bonusAmount, type: 'referral-5%', fromUser: userData.username, timestamp: serverTimestamp() });
                                
                                showMessage(`User updated. Bonus of ${formatCurrency(bonusAmount)} sent to referrer.`);
                            } else {
                               showMessage("User updated, but bonus not sent (invalid level).", true);
                            }
                        } else { 
                            showMessage("User updated. No referrer found for bonus."); 
                        }
                    } else {
                         showMessage('User updated successfully!'); 
                    }
                    
                    await batch.commit();
                    DOMElements.manageUserModal.classList.add('hidden'); 
                    selectedNotifDocId = null;

                } catch (err) { showMessage("An error occurred: " + err.message, true); console.error(err); }
            });


            // --- Auth State & Firestore Snapshots ---
            onAuthStateChanged(auth, user => {
                if (user && user.email.toLowerCase() === ADMIN_EMAIL) {
                    DOMElements.authContainer.style.display = 'none'; 
                    DOMElements.appContainer.style.display = 'block'; 
                    switchPage('dashboard');
                    setupInactivityDetection();

                    onSnapshot(query(collection(db, "users"), orderBy('createdAt', 'desc')), (snapshot) => {
                        const users = snapshot.docs.map(d => ({...d.data(), uid: d.id}));
                        renderAllUsers(users);
                    });
                    
                    const notifQuery = query(collection(db, "admin_notifications"), orderBy('timestamp', 'desc'));
                    onSnapshot(notifQuery, (snapshot) => { 
                        const allNotifs = snapshot.docs.map(d=>({...d.data(), id: d.id}));
                        
                        const deposits = allNotifs.filter(n => n.type === 'deposit_paid');
                        renderRequests(deposits, DOMElements.depositRequestsList, 'deposit'); 
                        DOMElements.pendingDepositsStat.textContent = deposits.length;
                        
                        const withdrawals = allNotifs.filter(n => n.type === 'withdrawal_request');
                        renderRequests(withdrawals, DOMElements.withdrawalRequestsList, 'withdrawal');
                        DOMElements.pendingWithdrawalsStat.textContent = withdrawals.length;
                    });
                } else {
                    DOMElements.authContainer.style.display = 'flex'; 
                    DOMElements.appContainer.style.display = 'none';
                    clearTimeout(inactivityTimer);
                    window.removeEventListener('mousemove', resetInactivityTimer);
                    window.removeEventListener('keypress', resetInactivityTimer);
                }
            });
        });
    </script>
</body>
</html>
