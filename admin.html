<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMF - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: background-color 0.2s; cursor: pointer; }
        .sidebar-link:hover, .sidebar-link.active { background-color: #4a5568; }
        .sidebar-link .fa-fw { width: 1.25em; text-align: center; margin-right: 0.75rem; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .stat-card { background-color: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .notification-badge { position: absolute; top: 0.5rem; right: 0.5rem; background-color: #f97316; color: white; border-radius: 9999px; font-size: 0.75rem; font-weight: bold; width: 1.5rem; height: 1.5rem; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Admin Login Section -->
    <div id="admin-login-container" class="min-h-screen flex items-center justify-center bg-gray-200 p-4">
        <div class="w-full max-w-sm bg-white rounded-2xl shadow-xl p-8">
            <h1 class="text-3xl font-bold text-center text-orange-500 mb-6">BMF Admin Login</h1>
            <div id="admin-error-message" class="mb-4 text-center text-red-500 font-medium h-5"></div>
            <form id="admin-login-form">
                <div class="mb-4"><label for="admin-email" class="block text-sm font-medium text-gray-700">Admin Email</label><input type="email" id="admin-email" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500"></div>
                <div class="mb-6"><label for="admin-password" class="block text-sm font-medium text-gray-700">Admin Password</label><input type="password" id="admin-password" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500"></div>
                <button type="submit" class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600 transition duration-300 shadow-lg">Login</button>
            </form>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel-container" class="hidden">
        <div class="flex h-screen bg-gray-800 text-white">
            <!-- Sidebar -->
            <nav class="w-64 flex-shrink-0 bg-slate-900 p-4 flex flex-col justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-center text-orange-500 mb-8 border-b border-gray-700 pb-4">BMF ADMIN</h2>
                    <ul class="space-y-3">
                        <li><div class="sidebar-link active" data-target="overview"><i class="fas fa-fw fa-tachometer-alt"></i>Overview</div></li>
                        <li class="relative"><div class="sidebar-link" data-target="deposits"><i class="fas fa-fw fa-download"></i>Deposit Requests</div><div id="deposits-badge" class="notification-badge hidden">0</div></li>
                        <li class="relative"><div class="sidebar-link" data-target="withdrawals"><i class="fas fa-fw fa-upload"></i>Withdrawal Requests</div><div id="withdrawals-badge" class="notification-badge hidden">0</div></li>
                        <li><div class="sidebar-link" data-target="users"><i class="fas fa-fw fa-users"></i>Manage Users</div></li>
                        <li><div class="sidebar-link" data-target="notifications"><i class="fas fa-fw fa-paper-plane"></i>Send Notifications</div></li>
                    </ul>
                </div>
                <button id="admin-logout-btn" class="sidebar-link w-full text-red-400 hover:bg-red-800/50"><i class="fas fa-fw fa-sign-out-alt"></i>Logout</button>
            </nav>

            <!-- Main Content -->
            <main class="flex-1 p-6 md:p-10 bg-gray-100 overflow-y-auto">
                <header class="mb-8"><h1 id="page-title" class="text-4xl font-bold text-gray-800">Overview</h1></header>
                <div id="overview-section" class="content-section active"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"><div class="stat-card"><h3 class="text-gray-500 font-semibold">Total Users</h3><p id="total-users-stat" class="text-3xl font-bold text-gray-800">0</p></div><div class="stat-card"><h3 class="text-gray-500 font-semibold">Total Platform Assets</h3><p id="total-assets-stat" class="text-3xl font-bold text-gray-800">Ksh 0.00</p></div><div class="stat-card"><h3 class="text-gray-500 font-semibold">Pending Deposits</h3><p id="pending-deposits-stat" class="text-3xl font-bold text-orange-500">0</p></div><div class="stat-card"><h3 class="text-gray-500 font-semibold">Pending Withdrawals</h3><p id="pending-withdrawals-stat" class="text-3xl font-bold text-orange-500">0</p></div></div></div>
                <div id="deposits-section" class="content-section"><div id="deposits-list" class="space-y-4 bg-white p-4 rounded-lg shadow"></div></div>
                <div id="withdrawals-section" class="content-section"><div id="withdrawals-list" class="space-y-4 bg-white p-4 rounded-lg shadow"></div></div>
                <div id="users-section" class="content-section"><div id="users-list" class="space-y-4 bg-white p-4 rounded-lg shadow max-h-[75vh] overflow-y-auto"></div></div>
                <div id="notifications-section" class="content-section">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Send a Notification</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="notification-user" class="block text-sm font-medium text-gray-700">Target User (Optional, leave blank for all)</label>
                                <!-- UPDATED: Changed placeholder text -->
                                <input type="text" id="notification-user-input" placeholder="Enter Username" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div><label for="notification-title" class="block text-sm font-medium text-gray-700">Title</label><input type="text" id="notification-title" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"></div>
                            <div><label for="notification-message" class="block text-sm font-medium text-gray-700">Message</label><textarea id="notification-message" rows="4" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"></textarea></div>
                            <div class="flex space-x-2">
                                <button id="send-notification-btn" class="w-full bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600">Send Notification</button>
                                <button id="send-welcome-btn" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">Send Welcome</button>
                                <button id="send-reminder-btn" class="w-full bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600">Send 2nd Withdraw Rule</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="user-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg text-gray-800 overflow-y-auto max-h-screen"><h3 class="font-bold text-xl mb-4" id="modal-username">User Details</h3><div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700">Set/Update Investment Level</label><select id="modal-level-select" class="mt-1 block w-full px-3 py-2 bg-slate-50 border rounded-md"></select></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700">Total Task Profits (Ksh)</label><input type="number" id="modal-task-profit" class="mt-1 block w-full px-3 py-2 bg-slate-50 border rounded-md"></div><div><label class="block text-sm font-medium text-gray-700">Total Referral Bonuses (Ksh)</label><input type="number" id="modal-referral-bonus" class="mt-1 block w-full px-3 py-2 bg-slate-50 border rounded-md"></div></div><div class="bg-gray-100 p-3 rounded-lg"><h4 class="font-semibold text-gray-700 mb-2">Referral Report</h4><div id="referral-report" class="text-sm space-y-1"></div></div></div><div class="mt-6 flex justify-end space-x-3"><button id="close-user-modal-btn" class="bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">Close</button><button id="update-user-btn" class="bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600">Update User</button></div></div></div>
    <div id="asset-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg text-gray-800"><h3 class="font-bold text-xl mb-4" id="asset-modal-username">Manage Assets</h3><div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700">Edit User's Total Assets (Ksh)</label><input type="number" id="modal-total-assets" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"></div><div class="bg-gray-100 p-3 rounded-lg"><h4 class="font-semibold text-gray-700 mb-2">Sponsor Bonus</h4><p class="text-sm">Sponsor: <span id="sponsor-info" class="font-medium text-blue-600">N/A</span></p><p class="text-xs text-gray-500 mb-2">Click to add a 5% referral bonus to the sponsor based on this user's current investment level.</p><button id="add-bonus-btn" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 disabled:bg-gray-400 disabled:cursor-not-allowed">Add 5% Referral Bonus to Sponsor</button></div></div><div class="mt-6 flex justify-end space-x-3"><button id="close-asset-modal-btn" class="bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">Close</button><button id="update-assets-btn" class="bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600">Update Assets</button></div></div></div>
    <div id="message-modal" class="hidden fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-xl z-50 animate-pulse"><p id="message-modal-text"></p></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, updateDoc, onSnapshot, query, orderBy, getDocs, deleteDoc, increment, addDoc, serverTimestamp, writeBatch, where, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener("DOMContentLoaded", () => {
            // --- Firebase and App Config ---
            const firebaseConfig = { apiKey: "AIzaSyAwf6foE2lZcv90wnQIRXguq-Z7jkIX8r8", authDomain: "bmf-6447b.firebaseapp.com", projectId: "bmf-6447b", storageBucket: "bmf-6447b.appspot.com", messagingSenderId: "249416500752", appId: "1:249416500752:web:88d421c17752fd08e7ac95", measurementId: "G-2SS309VMLB" };
            const ADMIN_EMAIL = 'cleophasamutete@gmail.com';
            const INVESTMENT_LEVELS = { 'freelance-1': { name: 'Freelance 1', investment: 4000 }, 'freelance-2': { name: 'Freelance 2', investment: 10000 }, 'freelance-3': { name: 'Freelance 3', investment: 25000 }, 'freelance-4': { name: 'Freelance 4', investment: 50000 }, 'manager-1': { name: 'Teamleader', investment: 100000 }, 'manager-2': { name: 'Supervisor', investment: 200000 }, 'manager-3': { name: 'Manager', investment: 500000 },'None': { name: 'None', investment: 0 }};
            let app, auth, db, selectedUserId = null, selectedUserData = null;
            try { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); } catch (e) { console.error("Firebase init failed:", e); }

            // --- DOM Elements ---
            const DOMElements = {
                loginContainer: document.getElementById('admin-login-container'), panelContainer: document.getElementById('admin-panel-container'), loginForm: document.getElementById('admin-login-form'), errorMessage: document.getElementById('admin-error-message'), logoutBtn: document.getElementById('admin-logout-btn'),
                navItems: document.querySelectorAll('.sidebar-link'), pages: { overview: document.getElementById('overview-section'), users: document.getElementById('users-section'), deposits: document.getElementById('deposits-section'), withdrawals: document.getElementById('withdrawals-section'), notifications: document.getElementById('notifications-section') },
                depositsList: document.getElementById('deposits-list'), withdrawalsList: document.getElementById('withdrawals-list'), usersList: document.getElementById('users-list'),
                userModal: document.getElementById('user-modal'), modalUsername: document.getElementById('modal-username'), modalLevelSelect: document.getElementById('modal-level-select'), modalTaskProfit: document.getElementById('modal-task-profit'), modalReferralBonus: document.getElementById('modal-referral-bonus'), referralReport: document.getElementById('referral-report'),
                updateUserBtn: document.getElementById('update-user-btn'), closeModalBtn: document.getElementById('close-user-modal-btn'),
                assetModal: document.getElementById('asset-modal'), assetModalUsername: document.getElementById('asset-modal-username'), modalTotalAssets: document.getElementById('modal-total-assets'), sponsorInfo: document.getElementById('sponsor-info'), addBonusBtn: document.getElementById('add-bonus-btn'), updateAssetsBtn: document.getElementById('update-assets-btn'), closeAssetModalBtn: document.getElementById('close-asset-modal-btn'),
                pageTitle: document.getElementById('page-title'), statTotalUsers: document.getElementById('total-users-stat'), statTotalAssets: document.getElementById('total-assets-stat'), statPendingDeposits: document.getElementById('pending-deposits-stat'), statPendingWithdrawals: document.getElementById('pending-withdrawals-stat'),
                depositsBadge: document.getElementById('deposits-badge'), withdrawalsBadge: document.getElementById('withdrawals-badge'),
                notificationUserInput: document.getElementById('notification-user-input'), // UPDATED: Changed ID
                notificationTitle: document.getElementById('notification-title'), notificationMessage: document.getElementById('notification-message'), sendNotificationBtn: document.getElementById('send-notification-btn'), sendWelcomeBtn: document.getElementById('send-welcome-btn'), sendReminderBtn: document.getElementById('send-reminder-btn'),
                messageModal: document.getElementById('message-modal'), messageModalText: document.getElementById('message-modal-text')
            };

            // --- Helper Functions ---
            const showMessage = (text, isError = false) => { DOMElements.messageModalText.textContent = text; DOMElements.messageModal.classList.toggle('bg-red-500', isError); DOMElements.messageModal.classList.toggle('bg-green-500', !isError); DOMElements.messageModal.classList.remove('hidden'); setTimeout(() => DOMElements.messageModal.classList.add('hidden'), 3500); };
            const updateBadge = (badge, count) => { badge.textContent = count; badge.classList.toggle('hidden', count === 0); };
            const formatCurrency = (amount) => `Ksh ${amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            const populateLevelSelect = () => { DOMElements.modalLevelSelect.innerHTML = Object.keys(INVESTMENT_LEVELS).map(key => `<option value="${key}">${INVESTMENT_LEVELS[key].name}</option>`).join(''); };
            
            // --- Main Action Functions ---
            const sendNotificationToUser = async (userId, title, message, type) => {
                const payload = { userId, title, message, type, timestamp: serverTimestamp(), isRead: false };
                await addDoc(collection(db, "notifications"), payload);
            };

            const sendNotificationToAll = async (title, message, type) => {
                const usersSnapshot = await getDocs(collection(db, "users"));
                const batch = writeBatch(db);
                usersSnapshot.forEach(userDoc => {
                    const notifRef = doc(collection(db, "notifications"));
                    batch.set(notifRef, { userId: userDoc.id, title, message, type, timestamp: serverTimestamp(), isRead: false });
                });
                await batch.commit();
            };

            // UPDATED: Main function to handle sending logic
            const handleSendNotification = async (targetUsername, title, message, type) => {
                try {
                    if (targetUsername) {
                        const q = query(collection(db, "users"), where("username", "==", targetUsername));
                        const querySnapshot = await getDocs(q);
                        if (querySnapshot.empty) {
                            showMessage(`Error: User with username "${targetUsername}" not found.`, true);
                            return;
                        }
                        const userDoc = querySnapshot.docs[0];
                        await sendNotificationToUser(userDoc.id, title, message, type);
                        showMessage(`Notification sent to ${targetUsername} successfully!`);
                    } else {
                        await sendNotificationToAll(title, message, type);
                        showMessage(`Notification sent to all users successfully!`);
                    }
                    DOMElements.notificationTitle.value = '';
                    DOMElements.notificationMessage.value = '';
                    DOMElements.notificationUserInput.value = '';
                } catch (err) {
                    showMessage("Error sending notification: " + err.message, true);
                    console.error(err);
                }
            };
            
            // --- Modal Functions ---
            const openUserModal = async (user) => { /* ... existing code ... */ };
            const openAssetModal = async (user) => { /* ... existing code ... */ };
            // --- Firestore Listeners ---
            const listenForNotifications = () => { /* ... existing code ... */ };
            const listenForUsers = () => { /* ... existing code ... */ };

            // --- App Initialization & Auth ---
            onAuthStateChanged(auth, user => { /* ... existing code ... */ });
            DOMElements.loginForm.addEventListener('submit', async e => { /* ... existing code ... */ });
            DOMElements.logoutBtn.addEventListener('click', () => signOut(auth));
            
            // --- Global Click Handler (Event Delegation) ---
            document.addEventListener('click', async e => { /* ... existing code ... */ });
            
            // --- Modal Button Listeners ---
            DOMElements.closeModalBtn.addEventListener('click', () => DOMElements.userModal.classList.add('hidden'));
            DOMElements.updateUserBtn.addEventListener('click', async () => { /* ... existing code ... */ });
            DOMElements.closeAssetModalBtn.addEventListener('click', () => DOMElements.assetModal.classList.add('hidden'));
            DOMElements.addBonusBtn.addEventListener('click', async () => { /* ... existing code ... */ });
            DOMElements.updateAssetsBtn.addEventListener('click', async () => { /* ... existing code ... */ });
            
            // --- Notification Sending Listeners ---
            DOMElements.sendNotificationBtn.addEventListener('click', () => {
                const title = DOMElements.notificationTitle.value.trim();
                const msg = DOMElements.notificationMessage.value.trim();
                const username = DOMElements.notificationUserInput.value.trim();
                if (!title || !msg) {
                    showMessage("Title and message are required.", true);
                    return;
                }
                handleSendNotification(username || null, title, msg, 'info');
            });

            DOMElements.sendWelcomeBtn.addEventListener('click', () => {
                const title = 'Welcome to BMF!';
                const msg = "We're thrilled to have you in the community. Your account is set up. To begin your earning journey, please make a deposit and contact us for activation. We wish you the best!";
                const username = DOMElements.notificationUserInput.value.trim();
                handleSendNotification(username || null, title, msg, 'info');
            });

            DOMElements.sendReminderBtn.addEventListener('click', () => {
                const title = 'Withdrawal Requirement';
                const msg = 'Congratulations on your progress! To unlock your second and all future withdrawals, our policy requires you to have at least two successfully referred members who have activated their accounts. This helps our community grow. Thank you!';
                const username = DOMElements.notificationUserInput.value.trim();
                handleSendNotification(username || null, title, msg, 'info');
            });
            
            // --- Sidebar Navigation ---
            DOMElements.navItems.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const targetId = link.dataset.target; if (!targetId || link.classList.contains('active')) return; DOMElements.navItems.forEach(l => l.classList.remove('active')); link.classList.add('active'); document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active')); document.getElementById(`${targetId}-section`).classList.add('active'); DOMElements.pageTitle.textContent = targetId.charAt(0).toUpperCase() + targetId.slice(1); }); });
        
            // Dummy listeners to ensure no errors from previous versions
            const dummyListeners = () => {
                const approveWithdrawalBtn = document.querySelector('.approve-withdrawal-btn');
                const rejectWithdrawalBtn = document.querySelector('.reject-withdrawal-btn');
                const deleteUserBtn = document.querySelector('.delete-user-btn');
                if(approveWithdrawalBtn) approveWithdrawalBtn.addEventListener('click', () => {});
                if(rejectWithdrawalBtn) rejectWithdrawalBtn.addEventListener('click', () => {});
                if(deleteUserBtn) deleteUserBtn.addEventListener('click', () => {});
           };
           dummyListeners();
        });
    </script>
</body>
</html>
