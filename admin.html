<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMF - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- PDF and Charting Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: background-color 0.2s; cursor: pointer; }
        .sidebar-link:hover, .sidebar-link.active { background-color: #4a5568; }
        .sidebar-link .fa-fw { width: 1.25em; text-align: center; margin-right: 0.75rem; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .stat-card { background-color: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .notification-badge { position: absolute; top: 0.5rem; right: 0.5rem; background-color: #f97316; color: white; border-radius: 9999px; font-size: 0.75rem; font-weight: bold; width: 1.5rem; height: 1.5rem; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="admin-login-container" class="min-h-screen flex items-center justify-center bg-gray-200 p-4">
        <div class="w-full max-w-sm bg-white rounded-2xl shadow-xl p-8">
            <h1 class="text-3xl font-bold text-center text-orange-500 mb-6">BMF Admin Login</h1>
            <div id="admin-error-message" class="mb-4 text-center text-red-500 font-medium h-5"></div>
            <form id="admin-login-form">
                <div class="mb-4"><label for="admin-email" class="block text-sm font-medium text-gray-700">Admin Email</label><input type="email" id="admin-email" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500"></div>
                <div class="mb-6"><label for="admin-password" class="block text-sm font-medium text-gray-700">Admin Password</label><input type="password" id="admin-password" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500"></div>
                <button type="submit" class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600 transition duration-300 shadow-lg">Login</button>
            </form>
        </div>
    </div>

    <div id="admin-panel-container" class="hidden">
        <div class="flex h-screen bg-gray-800 text-white">
            <nav class="w-64 flex-shrink-0 bg-slate-900 p-4 flex flex-col justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-center text-orange-500 mb-8 border-b border-gray-700 pb-4">BMF ADMIN</h2>
                    <ul class="space-y-3">
                        <li><div class="sidebar-link active" data-target="overview"><i class="fas fa-fw fa-tachometer-alt"></i>Overview</div></li>
                        <li class="relative"><div class="sidebar-link" data-target="deposits"><i class="fas fa-fw fa-download"></i>Deposit Requests</div><div id="deposits-badge" class="notification-badge hidden">0</div></li>
                        <li class="relative"><div class="sidebar-link" data-target="withdrawals"><i class="fas fa-fw fa-upload"></i>Withdrawal Requests</div><div id="withdrawals-badge" class="notification-badge hidden">0</div></li>
                        <li><div class="sidebar-link" data-target="users"><i class="fas fa-fw fa-users"></i>Manage Users</div></li>
                        <li><div class="sidebar-link" data-target="notifications"><i class="fas fa-fw fa-paper-plane"></i>Send Notifications</div></li>
                    </ul>
                </div>
                <button id="admin-logout-btn" class="sidebar-link w-full text-red-400 hover:bg-red-800/50"><i class="fas fa-fw fa-sign-out-alt"></i>Logout</button>
            </nav>

            <main class="flex-1 p-6 md:p-10 bg-gray-100 overflow-y-auto">
                <header class="mb-8"><h1 id="page-title" class="text-4xl font-bold text-gray-800">Overview</h1></header>
                <div id="overview-section" class="content-section active"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"><div class="stat-card"><h3 class="text-gray-500 font-semibold">Total Users</h3><p id="total-users-stat" class="text-3xl font-bold text-gray-800">0</p></div><div class="stat-card"><h3 class="text-gray-500 font-semibold">Total Platform Assets</h3><p id="total-assets-stat" class="text-3xl font-bold text-gray-800">Ksh 0.00</p></div><div class="stat-card"><h3 class="text-gray-500 font-semibold">Pending Deposits</h3><p id="pending-deposits-stat" class="text-3xl font-bold text-orange-500">0</p></div><div class="stat-card"><h3 class="text-gray-500 font-semibold">Pending Withdrawals</h3><p id="pending-withdrawals-stat" class="text-3xl font-bold text-orange-500">0</p></div></div></div>
                <div id="deposits-section" class="content-section"><div id="deposits-list" class="space-y-4 bg-white p-4 rounded-lg shadow"></div></div>
                <div id="withdrawals-section" class="content-section"><div id="withdrawals-list" class="space-y-4 bg-white p-4 rounded-lg shadow"></div></div>
                <div id="users-section" class="content-section"><div id="users-list" class="space-y-4 bg-white p-4 rounded-lg shadow max-h-[75vh] overflow-y-auto"></div></div>
                <div id="notifications-section" class="content-section">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Send a Notification</h2>
                        <div class="space-y-4">
                            <div><label for="notification-user" class="block text-lg font-medium text-gray-700">Target Username (Optional, leave blank for all)</label><input type="text" id="notification-username" placeholder="Enter Username" class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-md shadow-sm text-lg"></div>
                            <div><label for="notification-title" class="block text-lg font-medium text-gray-700">Title</label><input type="text" id="notification-title" class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-md shadow-sm text-lg"></div>
                            <div><label for="notification-message" class="block text-lg font-medium text-gray-700">Message</label><textarea id="notification-message" rows="5" class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-md shadow-sm text-lg"></textarea></div>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                                <button id="send-notification-btn" class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600">Send Custom</button>
                                <button id="send-welcome-btn" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600">Send Welcome</button>
                                <button id="send-reminder-btn" class="w-full bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-yellow-600">Send 2nd Withdraw Rule</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div id="user-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl text-gray-800 overflow-y-auto max-h-[90vh]"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-2xl" id="modal-username">User Details</h3><button id="close-user-modal-btn" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times fa-2x"></i></button></div><div class="space-y-6"><div><h4 class="font-semibold text-lg text-gray-700 mb-2 border-b pb-2">User Info & Controls</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm"><p><strong>Joined:</strong> <span id="modal-join-date"></span></p><p><strong>Activated:</strong> <span id="modal-activation-date"></span></p></div><div class="mt-4"><label class="block text-sm font-medium text-gray-700">Set/Update Investment Level</label><select id="modal-level-select" class="mt-1 block w-full px-3 py-2 bg-slate-50 border rounded-md"></select></div><div class="grid grid-cols-2 gap-4 mt-4"><div><label class="block text-sm font-medium text-gray-700">Total Task Profits (Ksh)</label><input type="number" id="modal-task-profit" class="mt-1 block w-full px-3 py-2 bg-slate-50 border rounded-md"></div><div><label class="block text-sm font-medium text-gray-700">Total Referral Bonuses (Ksh)</label><input type="number" id="modal-referral-bonus" class="mt-1 block w-full px-3 py-2 bg-slate-50 border rounded-md"></div></div></div><div><h4 class="font-semibold text-lg text-gray-700 mb-2 border-b pb-2">Earnings Chart</h4><canvas id="earnings-chart"></canvas></div><div><h4 class="font-semibold text-lg text-gray-700 mb-2 border-b pb-2">Referral Report</h4><div id="referral-report" class="text-sm space-y-1"></div></div></div><div class="mt-6 flex justify-end space-x-3"><button id="download-report-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Download PDF Report</button><button id="update-user-btn" class="bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600">Update User</button></div></div></div>
    <div id="message-modal" class="hidden fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-xl z-50 animate-pulse"><p id="message-modal-text"></p></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, updateDoc, onSnapshot, query, orderBy, getDocs, deleteDoc, increment, addDoc, serverTimestamp, writeBatch, where, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener("DOMContentLoaded", () => {
            const firebaseConfig = { apiKey: "AIzaSyAwf6foE2lZcv90wnQIRXguq-Z7jkIX8r8", authDomain: "bmf-6447b.firebaseapp.com", projectId: "bmf-6447b", storageBucket: "bmf-6447b.appspot.com", messagingSenderId: "249416500752", appId: "1:249416500752:web:88d421c17752fd08e7ac95", measurementId: "G-2SS309VMLB" };
            const ADMIN_EMAIL = 'cleophasamutete@gmail.com';
            const INVESTMENT_LEVELS = { 'freelance-1': { name: 'Freelance 1', investment: 4000 }, 'freelance-2': { name: 'Freelance 2', investment: 10000 }, 'freelance-3': { name: 'Freelance 3', investment: 25000 }, 'freelance-4': { name: 'Freelance 4', investment: 50000 }, 'manager-1': { name: 'Teamleader', investment: 100000 }, 'manager-2': { name: 'Supervisor', investment: 200000 }, 'manager-3': { name: 'Manager', investment: 500000 },'None': { name: 'None', investment: 0 }};
            let app, auth, db, selectedUserId = null, selectedUserData = null, earningsChart = null;
            try { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); } catch (e) { console.error("Firebase init failed:", e); }

            const DOMElements = {
                loginContainer: document.getElementById('admin-login-container'), panelContainer: document.getElementById('admin-panel-container'), loginForm: document.getElementById('admin-login-form'), errorMessage: document.getElementById('admin-error-message'), logoutBtn: document.getElementById('admin-logout-btn'),
                navItems: document.querySelectorAll('.sidebar-link'), pages: { overview: document.getElementById('overview-section'), users: document.getElementById('users-section'), deposits: document.getElementById('deposits-section'), withdrawals: document.getElementById('withdrawals-section'), notifications: document.getElementById('notifications-section') },
                depositsList: document.getElementById('deposits-list'), withdrawalsList: document.getElementById('withdrawals-list'), usersList: document.getElementById('users-list'),
                userModal: document.getElementById('user-modal'), modalUsername: document.getElementById('modal-username'), modalLevelSelect: document.getElementById('modal-level-select'), modalTaskProfit: document.getElementById('modal-task-profit'), modalReferralBonus: document.getElementById('modal-referral-bonus'), referralReport: document.getElementById('referral-report'), modalJoinDate: document.getElementById('modal-join-date'), modalActivationDate: document.getElementById('modal-activation-date'),
                updateUserBtn: document.getElementById('update-user-btn'), closeModalBtn: document.getElementById('close-user-modal-btn'), downloadReportBtn: document.getElementById('download-report-btn'),
                pageTitle: document.getElementById('page-title'), statTotalUsers: document.getElementById('total-users-stat'), statTotalAssets: document.getElementById('total-assets-stat'), statPendingDeposits: document.getElementById('pending-deposits-stat'), statPendingWithdrawals: document.getElementById('pending-withdrawals-stat'),
                depositsBadge: document.getElementById('deposits-badge'), withdrawalsBadge: document.getElementById('withdrawals-badge'),
                notificationUsername: document.getElementById('notification-username'), notificationTitle: document.getElementById('notification-title'), notificationMessage: document.getElementById('notification-message'), sendNotificationBtn: document.getElementById('send-notification-btn'), sendWelcomeBtn: document.getElementById('send-welcome-btn'), sendReminderBtn: document.getElementById('send-reminder-btn'),
                messageModal: document.getElementById('message-modal'), messageModalText: document.getElementById('message-modal-text')
            };

            const showMessage = (text, isError = false) => { DOMElements.messageModalText.textContent = text; DOMElements.messageModal.classList.toggle('bg-red-500', isError); DOMElements.messageModal.classList.toggle('bg-green-500', !isError); DOMElements.messageModal.classList.remove('hidden'); setTimeout(() => DOMElements.messageModal.classList.add('hidden'), 3500); };
            const updateBadge = (badge, count) => { badge.textContent = count; badge.classList.toggle('hidden', count === 0); };
            const formatCurrency = (amount) => `Ksh ${amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            const populateLevelSelect = () => { DOMElements.modalLevelSelect.innerHTML = Object.keys(INVESTMENT_LEVELS).map(key => `<option value="${key}">${INVESTMENT_LEVELS[key].name}</option>`).join(''); };
            
            const sendNotification = async (target, title, message, type) => {
                try {
                    const payload = { title, message, type, timestamp: serverTimestamp(), isRead: false };
                    if (target) {
                        const q = query(collection(db, "users"), where("username", "==", target));
                        const userSnapshot = await getDocs(q);
                        if (userSnapshot.empty) { showMessage(`User "${target}" not found.`, true); return; }
                        const userId = userSnapshot.docs[0].id;
                        payload.userId = userId;
                        await addDoc(collection(db, "notifications"), payload);
                    } else { 
                        const usersSnapshot = await getDocs(collection(db, "users"));
                        const batch = writeBatch(db);
                        usersSnapshot.forEach(userDoc => {
                            const notifRef = doc(collection(db, "notifications"));
                            batch.set(notifRef, { ...payload, userId: userDoc.id });
                        });
                        await batch.commit();
                    }
                    showMessage(`Notification sent successfully!`);
                    DOMElements.notificationTitle.value = ''; DOMElements.notificationMessage.value = ''; DOMElements.notificationUsername.value = '';
                } catch (err) { showMessage("Error sending notification: " + err.message, true); }
            };
            
            const openUserModal = async (user) => {
                selectedUserId = user.uid;
                selectedUserData = user;
                DOMElements.modalUsername.textContent = `Manage: ${user.username}`;
                DOMElements.modalLevelSelect.value = user.investmentLevel || 'None';
                DOMElements.modalTaskProfit.value = user.totalTaskProfit || 0;
                DOMElements.modalReferralBonus.value = user.totalReferralBonus || 0;
                DOMElements.modalJoinDate.textContent = user.createdAt?.toDate().toLocaleString() || 'N/A';
                DOMElements.modalActivationDate.textContent = user.activationDate?.toDate().toLocaleString() || 'Not Activated';
                DOMElements.userModal.classList.remove('hidden');
                
                DOMElements.referralReport.innerHTML = `<p>Loading report...</p>`;
                const q = query(collection(db, 'users'), where("referrerId", "==", user.uid));
                const snapshot = await getDocs(q);
                const referrals = snapshot.docs.map(doc => doc.data());
                const activeReferrals = referrals.filter(r => r.investmentLevel !== 'None').length;
                DOMElements.referralReport.innerHTML = `<p><strong>Total Referrals:</strong> ${referrals.length}</p><p><strong>Active Referrals:</strong> ${activeReferrals}</p><p><strong>Dormant Referrals:</strong> ${referrals.length - activeReferrals}</p>`;

                // Chart
                const transactionsQuery = query(collection(db, "transactions"), where("userId", "==", user.uid), where("type", "==", "task"), orderBy("timestamp", "asc"));
                const transactionsSnapshot = await getDocs(transactionsQuery);
                const earningsByDay = {};
                transactionsSnapshot.forEach(doc => {
                    const t = doc.data();
                    const date = t.timestamp.toDate().toISOString().split('T')[0];
                    earningsByDay[date] = (earningsByDay[date] || 0) + t.amount;
                });
                const chartLabels = Object.keys(earningsByDay);
                const chartData = Object.values(earningsByDay);
                if (earningsChart) earningsChart.destroy();
                earningsChart = new Chart(document.getElementById('earnings-chart'), {
                    type: 'bar',
                    data: { labels: chartLabels, datasets: [{ label: 'Daily Task Earnings (Ksh)', data: chartData, backgroundColor: 'rgba(249, 115, 22, 0.6)', borderColor: 'rgba(249, 115, 22, 1)', borderWidth: 1 }] },
                    options: { scales: { y: { beginAtZero: true } } }
                });
            };

            const generatePDFReport = async () => {
                if (!selectedUserData) return;
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(18);
                doc.text(`User Report: ${selectedUserData.username}`, 14, 22);
                doc.setFontSize(11);
                doc.setTextColor(100);
                doc.text(`User ID: ${selectedUserData.uid}`, 14, 30);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 36);

                // Fetch transactions
                const transQuery = query(collection(db, "transactions"), where("userId", "==", selectedUserData.uid), orderBy("timestamp", "desc"));
                const transSnapshot = await getDocs(transQuery);
                const transactions = transSnapshot.docs.map(d => {
                    const t = d.data();
                    const amount = t.type === 'withdrawal' ? `-${formatCurrency(t.amount)}` : `+${formatCurrency(t.amount)}`;
                    return [ t.timestamp.toDate().toLocaleString(), t.type, t.description || '-', amount ];
                });

                doc.autoTable({
                    head: [['Date', 'Type', 'Description', 'Amount']],
                    body: transactions,
                    startY: 50,
                    headStyles: { fillColor: [249, 115, 22] },
                });

                // Fetch team
                const teamQuery = query(collection(db, "users"), where("referrerId", "==", selectedUserData.uid));
                const teamSnapshot = await getDocs(teamQuery);
                const team = teamSnapshot.docs.map(d => {
                    const t = d.data();
                    return [ t.username, t.investmentLevel === 'None' ? 'Not Active' : 'Active', t.createdAt.toDate().toLocaleDateString() ];
                });

                doc.autoTable({
                    head: [['Username', 'Status', 'Join Date']],
                    body: team,
                    startY: doc.lastAutoTable.finalY + 10,
                    headStyles: { fillColor: [75, 85, 99] },
                    didDrawPage: (data) => { doc.text('Referral Team', 14, data.cursor.y - 10); }
                });
                
                doc.save(`report-${selectedUserData.username}-${new Date().toISOString().split('T')[0]}.pdf`);
            };

            const listenForNotifications = () => {
                const q = query(collection(db, 'admin_notifications'), orderBy('timestamp', 'desc'));
                onSnapshot(q, (snapshot) => {
                    DOMElements.depositsList.innerHTML = '<p class="text-gray-500 p-4 text-center">No new deposit requests.</p>';
                    DOMElements.withdrawalsList.innerHTML = '<p class="text-gray-500 p-4 text-center">No new withdrawal requests.</p>';
                    let depositCount = 0, withdrawalCount = 0, hasDeposits = false, hasWithdrawals = false;
                    snapshot.forEach(docSnap => {
                        const notif = {...docSnap.data(), id: docSnap.id};
                        const el = document.createElement('div'); el.className = 'border p-3 rounded-lg shadow-sm bg-white text-gray-800';
                        if (notif.type === 'deposit_paid') {
                           if (!hasDeposits) { DOMElements.depositsList.innerHTML = ''; hasDeposits = true; }
                            el.innerHTML = `<div><p><span class="font-semibold">${notif.username}</span> reported a deposit.</p><p class="text-xs text-gray-500">User ID: ${notif.userId}</p></div><div class="flex space-x-2 mt-2"><button data-notif='${JSON.stringify(notif)}' class="activate-user-btn flex-1 bg-blue-500 text-white text-sm font-semibold py-1 px-3 rounded hover:bg-blue-600">Activate</button><button data-notif='${JSON.stringify(notif)}' class="reject-deposit-btn flex-1 bg-red-500 text-white text-sm font-semibold py-1 px-3 rounded hover:bg-red-600">Reject</button></div>`;
                            DOMElements.depositsList.appendChild(el); depositCount++;
                        } else if (notif.type === 'withdrawal_request') {
                           if (!hasWithdrawals) { DOMElements.withdrawalsList.innerHTML = ''; hasWithdrawals = true; }
                            el.innerHTML = `<div><p><span class="font-semibold">${notif.username}</span> requests <span class="font-bold">${formatCurrency(notif.amount)}</span>.</p><p class="text-sm text-blue-600 font-semibold">M-Pesa No: ${notif.phone}</p><p class="text-xs text-gray-500">User ID: ${notif.userId}</p></div><div class="flex space-x-2 mt-2"><button data-notif='${JSON.stringify(notif)}' class="approve-withdrawal-btn flex-1 bg-green-500 text-white text-sm font-semibold py-1 px-3 rounded hover:bg-green-600">Approve</button><button data-notif='${JSON.stringify(notif)}' class="reject-withdrawal-btn flex-1 bg-yellow-500 text-white text-sm font-semibold py-1 px-3 rounded hover:bg-yellow-600">Reject</button></div>`;
                            DOMElements.withdrawalsList.appendChild(el); withdrawalCount++;
                        }
                    });
                    updateBadge(DOMElements.depositsBadge, depositCount); updateBadge(DOMElements.withdrawalsBadge, withdrawalCount);
                    DOMElements.statPendingDeposits.textContent = depositCount; DOMElements.statPendingWithdrawals.textContent = withdrawalCount;
                });
            };
            
            const listenForUsers = () => { /* (Existing logic - unchanged) */ };

            onAuthStateChanged(auth, user => { DOMElements.loginContainer.style.display = 'none'; DOMElements.panelContainer.classList.add('hidden'); if (user && user.email.toLowerCase() === ADMIN_EMAIL) { DOMElements.panelContainer.classList.remove('hidden'); populateLevelSelect(); listenForNotifications(); listenForUsers(); } else { DOMElements.loginContainer.style.display = 'flex'; if (user) signOut(auth); } });
            DOMElements.loginForm.addEventListener('submit', async e => { e.preventDefault(); const email = DOMElements.loginForm['admin-email'].value; DOMElements.errorMessage.textContent = ''; if (email.toLowerCase() !== ADMIN_EMAIL) { DOMElements.errorMessage.textContent = "Unauthorized email."; return; } try { await signInWithEmailAndPassword(auth, email, DOMElements.loginForm['admin-password'].value); } catch (e) { DOMElements.errorMessage.textContent = e.message; } });
            DOMElements.logoutBtn.addEventListener('click', () => signOut(auth));
            
            document.addEventListener('click', async e => {
                const notifData = e.target.dataset.notif ? JSON.parse(e.target.dataset.notif) : null;
                if (e.target.closest('.activate-user-btn')) { showMessage("Opening manager... Set user's level and profits to activate account.", false); openUserModal({uid: notifData.userId, username: notifData.username, totalAssets: 0, investmentLevel: 'None'}); }
                if (e.target.closest('.reject-deposit-btn')) { if (!confirm("Reject this deposit request? A notification will be sent.")) return; try { await deleteDoc(doc(db, 'admin_notifications', notifData.id)); await sendNotification(notifData.username, 'Deposit Request Rejected', `Your recent deposit notification was rejected. Please ensure you have made the deposit correctly before notifying the admin.`, 'rejected'); showMessage("Deposit rejected."); } catch (err) { showMessage("Error: " + err.message, true); } }
                if (e.target.closest('.approve-withdrawal-btn')) { if (!confirm("Have you sent the money? This approves the request and notifies the user.")) return; try { await deleteDoc(doc(db, 'admin_notifications', notifData.id)); await sendNotification(notifData.username, 'Withdrawal Approved', `Your withdrawal request of ${formatCurrency(notifData.amount)} has been approved and processed.`, 'approved'); showMessage("Withdrawal approved."); } catch (err) { showMessage("Error: " + err.message, true); } }
                if (e.target.closest('.reject-withdrawal-btn')) { if (!confirm("Reject this withdrawal? Funds will be returned and user will be notified.")) return; try { const batch = writeBatch(db); const userRef = doc(db, 'users', notifData.userId); batch.update(userRef, { totalAssets: increment(notifData.amount), lastWithdrawalDate: null }); batch.delete(doc(db, 'admin_notifications', notifData.id)); await batch.commit(); await sendNotification(notifData.username, 'Withdrawal Rejected', `Your withdrawal request of ${formatCurrency(notifData.amount)} was rejected. The funds have been returned to your account.`, 'rejected'); showMessage("Withdrawal rejected."); } catch (err) { showMessage("Error: " + err.message, true); } }
                if (e.target.closest('.delete-user-btn')) { const uname = e.target.dataset.uname; if (!confirm(`DANGER: Permanently delete user data for "${uname}"?`)) return; try { await deleteDoc(doc(db, "users", e.target.dataset.uid)); showMessage(`User data for "${uname}" has been deleted.`); } catch (err) { showMessage("Error: " + err.message, true); } }
            });
            
            DOMElements.closeModalBtn.addEventListener('click', () => DOMElements.userModal.classList.add('hidden'));
            DOMElements.downloadReportBtn.addEventListener('click', generatePDFReport);
            DOMElements.updateUserBtn.addEventListener('click', async () => {
                if (!selectedUserId) return;
                const newLevel = DOMElements.modalLevelSelect.value;
                const updatePayload = { investmentLevel: newLevel, totalTaskProfit: parseFloat(DOMElements.modalTaskProfit.value), totalReferralBonus: parseFloat(DOMElements.modalReferralBonus.value) };
                if (selectedUserData.investmentLevel === 'None' && newLevel !== 'None') { updatePayload.activationDate = serverTimestamp(); }
                if (isNaN(updatePayload.totalTaskProfit) || isNaN(updatePayload.totalReferralBonus)) { showMessage("Invalid profit/bonus amount.", true); return; }
                try { await updateDoc(doc(db, 'users', selectedUserId), updatePayload); showMessage('User updated successfully!'); DOMElements.userModal.classList.add('hidden'); } catch (err) { showMessage("Error: " + err.message, true); }
            });
            
            DOMElements.sendNotificationBtn.addEventListener('click', () => { const title = DOMElements.notificationTitle.value; const msg = DOMElements.notificationMessage.value; if (!title || !msg) { showMessage("Title and message are required.", true); return; } sendNotification(DOMElements.notificationUsername.value.trim() || null, title, msg, 'info'); });
            DOMElements.sendWelcomeBtn.addEventListener('click', () => { const title = 'Welcome to BMF!'; const msg = "We're thrilled to have you in the community. Your account is set up. To begin your earning journey, please make a deposit and contact us for activation. We wish you the best!"; sendNotification(DOMElements.notificationUsername.value.trim() || null, title, msg, 'info'); });
            DOMElements.sendReminderBtn.addEventListener('click', () => { const title = 'Withdrawal Requirement'; const msg = 'Congratulations on your progress! To unlock your second and all future withdrawals, our policy requires you to have at least two successfully referred members who have activated their accounts. This helps our community grow. Thank you!'; sendNotification(DOMElements.notificationUsername.value.trim() || null, title, msg, 'info'); });
            
            DOMElements.navItems.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const targetId = link.dataset.target; if (!targetId || link.classList.contains('active')) return; DOMElements.navItems.forEach(l => l.classList.remove('active')); link.classList.add('active'); document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active')); document.getElementById(`${targetId}-section`).classList.add('active'); DOMElements.pageTitle.textContent = targetId.charAt(0).toUpperCase() + targetId.slice(1); }); });
        });
    </script>
</body>
</html>
